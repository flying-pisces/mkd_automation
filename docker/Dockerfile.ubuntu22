# Dockerfile for building MKD Automation on Ubuntu 22.04
FROM ubuntu:22.04

# Prevent interactive prompts during package installation
ENV DEBIAN_FRONTEND=noninteractive
ENV PYTHONUNBUFFERED=1

# Install system dependencies
RUN apt-get update && apt-get install -y \
    python3 \
    python3-pip \
    python3-venv \
    python3-dev \
    python3-tk \
    build-essential \
    git \
    curl \
    wget \
    libx11-dev \
    libxtst6 \
    libxrandr2 \
    libxss1 \
    libgconf-2-4 \
    libnss3 \
    libxss1 \
    libasound2 \
    libpangocairo-1.0-0 \
    libatk1.0-0 \
    libcairo-gobject2 \
    libgtk-3-0 \
    libgdk-pixbuf2.0-0 \
    libxcomposite1 \
    libxcursor1 \
    libxi6 \
    libxdamage1 \
    libxfixes3 \
    libxrender1 \
    && rm -rf /var/lib/apt/lists/*

# Create working directory
WORKDIR /app

# Copy requirements and install Python dependencies
COPY requirements*.txt ./
RUN python3 -m pip install --upgrade pip && \
    pip3 install pyinstaller && \
    if [ -f requirements.txt ]; then pip3 install -r requirements.txt; fi && \
    if [ -f requirements-dev.txt ]; then pip3 install -r requirements-dev.txt; fi

# Copy source code
COPY src/ ./src/
COPY *.spec ./
COPY build_universal.py ./

# Set executable permissions
RUN chmod +x build_universal.py

# Create entrypoint script
RUN echo '#!/bin/bash\n\
echo "🐧 Building MKD Automation for Linux Ubuntu 22.04"\n\
echo "================================================"\n\
\n\
# Build the application\n\
python3 build_universal.py\n\
\n\
# Copy results to mounted volume if available\n\
if [ -d "/output" ]; then\n\
    echo "📦 Copying results to /output..."\n\
    cp -r release/* /output/\n\
    echo "✅ Build artifacts copied to host"\n\
fi\n\
\n\
echo "🎉 Linux build complete!"' > /app/entrypoint.sh && \
    chmod +x /app/entrypoint.sh

# Default command
CMD ["/app/entrypoint.sh"]