<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Screen Capture - MKD Automation</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 {
            color: #333;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        .test-button:hover {
            background: #45a049;
        }
        .test-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        #status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            background: #e7f3ff;
            border: 1px solid #2196F3;
        }
        .success {
            background: #d4edda !important;
            border-color: #28a745 !important;
            color: #155724;
        }
        .error {
            background: #f8d7da !important;
            border-color: #dc3545 !important;
            color: #721c24;
        }
        pre {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>MKD Web GUI - Screen Capture Test</h1>
    
    <div class="test-section">
        <h2>Test Instructions</h2>
        <ol>
            <li>Click "Test Video Capture" to test screen recording with video</li>
            <li>Select a screen/window to share when prompted</li>
            <li>Perform some actions for 5-10 seconds</li>
            <li>Click "Stop and Check Storage" to verify storage</li>
            <li>Click "Test Replay" to replay the recording</li>
        </ol>
    </div>
    
    <div class="test-section">
        <h2>Test Controls</h2>
        <button id="testVideoBtn" class="test-button">Test Video Capture</button>
        <button id="testScreenshotBtn" class="test-button">Test Screenshot Capture</button>
        <button id="stopBtn" class="test-button" disabled>Stop and Check Storage</button>
        <button id="replayBtn" class="test-button" disabled>Test Replay</button>
        <button id="clearBtn" class="test-button">Clear Storage</button>
        
        <div id="status">Ready to test</div>
    </div>
    
    <div class="test-section">
        <h2>Storage Info</h2>
        <pre id="storageInfo">No data stored yet</pre>
    </div>
    
    <div class="test-section">
        <h2>Replay Container</h2>
        <div id="replayContainer" style="border: 2px solid #ddd; min-height: 300px; display: flex; align-items: center; justify-content: center;">
            <span style="color: #999;">Recording will replay here</span>
        </div>
    </div>

    <script>
        class ScreenCaptureTest {
            constructor() {
                this.mediaRecorder = null;
                this.recordedChunks = [];
                this.screenStream = null;
                this.screenshots = [];
                this.captureInterval = null;
                this.isRecording = false;
                
                this.initUI();
            }
            
            initUI() {
                this.videoBtn = document.getElementById('testVideoBtn');
                this.screenshotBtn = document.getElementById('testScreenshotBtn');
                this.stopBtn = document.getElementById('stopBtn');
                this.replayBtn = document.getElementById('replayBtn');
                this.clearBtn = document.getElementById('clearBtn');
                this.status = document.getElementById('status');
                this.storageInfo = document.getElementById('storageInfo');
                this.replayContainer = document.getElementById('replayContainer');
                
                this.videoBtn.addEventListener('click', () => this.testVideoCapture());
                this.screenshotBtn.addEventListener('click', () => this.testScreenshotCapture());
                this.stopBtn.addEventListener('click', () => this.stopAndStore());
                this.replayBtn.addEventListener('click', () => this.testReplay());
                this.clearBtn.addEventListener('click', () => this.clearStorage());
                
                this.updateStorageInfo();
            }
            
            updateStatus(message, type = 'info') {
                this.status.textContent = message;
                this.status.className = type === 'success' ? 'success' : type === 'error' ? 'error' : '';
            }
            
            async testVideoCapture() {
                try {
                    this.updateStatus('Requesting screen capture permission...');
                    
                    this.screenStream = await navigator.mediaDevices.getDisplayMedia({
                        video: { mediaSource: 'screen' },
                        audio: false
                    });
                    
                    if (typeof MediaRecorder !== 'undefined' && MediaRecorder.isTypeSupported('video/webm')) {
                        const options = { mimeType: 'video/webm;codecs=vp8' };
                        this.mediaRecorder = new MediaRecorder(this.screenStream, options);
                        
                        this.mediaRecorder.ondataavailable = (event) => {
                            if (event.data.size > 0) {
                                this.recordedChunks.push(event.data);
                            }
                        };
                        
                        this.mediaRecorder.start(1000);
                        this.isRecording = true;
                        
                        this.updateStatus('Recording video... Click "Stop and Check Storage" when done', 'success');
                        this.videoBtn.disabled = true;
                        this.screenshotBtn.disabled = true;
                        this.stopBtn.disabled = false;
                    } else {
                        this.updateStatus('MediaRecorder not supported, falling back to screenshots', 'error');
                        await this.captureScreenshots();
                    }
                } catch (error) {
                    this.updateStatus(`Error: ${error.message}`, 'error');
                    console.error(error);
                }
            }
            
            async testScreenshotCapture() {
                try {
                    this.updateStatus('Requesting screen capture permission...');
                    
                    this.screenStream = await navigator.mediaDevices.getDisplayMedia({
                        video: { mediaSource: 'screen' },
                        audio: false
                    });
                    
                    await this.captureScreenshots();
                    
                } catch (error) {
                    this.updateStatus(`Error: ${error.message}`, 'error');
                    console.error(error);
                }
            }
            
            async captureScreenshots() {
                const video = document.createElement('video');
                video.srcObject = this.screenStream;
                video.autoplay = true;
                video.style.display = 'none';
                document.body.appendChild(video);
                
                await new Promise(resolve => {
                    video.onloadedmetadata = resolve;
                });
                
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                this.isRecording = true;
                this.updateStatus('Capturing screenshots (2 FPS)... Click "Stop and Check Storage" when done', 'success');
                this.videoBtn.disabled = true;
                this.screenshotBtn.disabled = true;
                this.stopBtn.disabled = false;
                
                this.captureInterval = setInterval(() => {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    ctx.drawImage(video, 0, 0);
                    
                    canvas.toBlob((blob) => {
                        if (blob) {
                            const reader = new FileReader();
                            reader.onloadend = () => {
                                this.screenshots.push({
                                    timestamp: Date.now(),
                                    data: reader.result
                                });
                                this.updateStatus(`Captured ${this.screenshots.length} screenshots...`, 'success');
                            };
                            reader.readAsDataURL(blob);
                        }
                    }, 'image/jpeg', 0.7);
                }, 500);
            }
            
            async stopAndStore() {
                this.isRecording = false;
                
                // Stop capture
                if (this.mediaRecorder && this.mediaRecorder.state !== 'inactive') {
                    this.mediaRecorder.stop();
                    await new Promise(resolve => {
                        this.mediaRecorder.onstop = resolve;
                    });
                }
                
                if (this.captureInterval) {
                    clearInterval(this.captureInterval);
                    this.captureInterval = null;
                }
                
                if (this.screenStream) {
                    this.screenStream.getTracks().forEach(track => track.stop());
                }
                
                // Store the recording
                const recording = {};
                
                if (this.recordedChunks.length > 0) {
                    const blob = new Blob(this.recordedChunks, { type: 'video/webm' });
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        recording.video = reader.result;
                        recording.type = 'video';
                        recording.size = blob.size;
                        localStorage.setItem('test_recording', JSON.stringify(recording));
                        this.updateStatus('Video stored successfully!', 'success');
                        this.updateStorageInfo();
                        this.replayBtn.disabled = false;
                    };
                    reader.readAsDataURL(blob);
                } else if (this.screenshots.length > 0) {
                    recording.screenshots = this.screenshots;
                    recording.type = 'screenshots';
                    recording.count = this.screenshots.length;
                    localStorage.setItem('test_recording', JSON.stringify(recording));
                    this.updateStatus(`${this.screenshots.length} screenshots stored successfully!`, 'success');
                    this.updateStorageInfo();
                    this.replayBtn.disabled = false;
                }
                
                // Reset buttons
                this.videoBtn.disabled = false;
                this.screenshotBtn.disabled = false;
                this.stopBtn.disabled = true;
                
                // Clean up
                const videos = document.querySelectorAll('video[style*="display: none"]');
                videos.forEach(v => v.remove());
            }
            
            testReplay() {
                const recording = JSON.parse(localStorage.getItem('test_recording') || '{}');
                
                if (recording.video) {
                    this.replayVideo(recording.video);
                } else if (recording.screenshots) {
                    this.replayScreenshots(recording.screenshots);
                } else {
                    this.updateStatus('No recording found to replay', 'error');
                }
            }
            
            replayVideo(videoData) {
                this.replayContainer.innerHTML = '';
                const video = document.createElement('video');
                video.src = videoData;
                video.controls = true;
                video.style.width = '100%';
                video.style.maxHeight = '500px';
                this.replayContainer.appendChild(video);
                video.play();
                this.updateStatus('Playing video recording', 'success');
            }
            
            replayScreenshots(screenshots) {
                this.replayContainer.innerHTML = '';
                const img = document.createElement('img');
                img.style.width = '100%';
                img.style.maxHeight = '500px';
                this.replayContainer.appendChild(img);
                
                let index = 0;
                const showNext = () => {
                    if (index < screenshots.length) {
                        img.src = screenshots[index].data;
                        this.updateStatus(`Showing screenshot ${index + 1} of ${screenshots.length}`, 'success');
                        index++;
                        setTimeout(showNext, 500);
                    } else {
                        this.updateStatus('Replay complete', 'success');
                    }
                };
                showNext();
            }
            
            clearStorage() {
                localStorage.removeItem('test_recording');
                this.recordedChunks = [];
                this.screenshots = [];
                this.updateStorageInfo();
                this.updateStatus('Storage cleared', 'success');
                this.replayBtn.disabled = true;
                this.replayContainer.innerHTML = '<span style="color: #999;">Recording will replay here</span>';
            }
            
            updateStorageInfo() {
                const recording = localStorage.getItem('test_recording');
                if (recording) {
                    const data = JSON.parse(recording);
                    const size = new Blob([recording]).size;
                    this.storageInfo.textContent = JSON.stringify({
                        type: data.type,
                        storageSize: `${(size / 1024).toFixed(2)} KB`,
                        videoChunks: data.video ? 'Yes' : 'No',
                        screenshotCount: data.count || 0
                    }, null, 2);
                } else {
                    this.storageInfo.textContent = 'No data stored yet';
                }
            }
        }
        
        // Initialize test
        const test = new ScreenCaptureTest();
    </script>
</body>
</html>