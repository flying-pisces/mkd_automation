<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Combined Video + Action Capture Test - MKD Automation</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .test-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .full-width {
            grid-column: 1 / -1;
        }
        .btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            margin: 8px 4px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }
        .btn:hover {
            background: #45a049;
        }
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .btn.recording {
            background: #ff4444;
            animation: pulse 2s infinite;
        }
        .btn.stop {
            background: #ff6b35;
        }
        .btn.replay {
            background: #2196F3;
        }
        @keyframes pulse {
            0% { background-color: #ff4444; }
            50% { background-color: #ff6666; }
            100% { background-color: #ff4444; }
        }
        #status {
            padding: 15px;
            margin: 10px 0;
            border-radius: 6px;
            background: #e7f3ff;
            border: 1px solid #2196F3;
            font-weight: bold;
        }
        .success {
            background: #d4edda !important;
            border-color: #28a745 !important;
            color: #155724;
        }
        .error {
            background: #f8d7da !important;
            border-color: #dc3545 !important;
            color: #721c24;
        }
        .recording-indicator {
            background: #ffe6e6 !important;
            border-color: #ff4444 !important;
            color: #cc0000;
        }
        #activityArea {
            min-height: 300px;
            background: linear-gradient(45deg, #f0f0f0 25%, transparent 25%), 
                        linear-gradient(-45deg, #f0f0f0 25%, transparent 25%), 
                        linear-gradient(45deg, transparent 75%, #f0f0f0 75%), 
                        linear-gradient(-45deg, transparent 75%, #f0f0f0 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
            border: 2px solid #ddd;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: #666;
            cursor: crosshair;
            position: relative;
        }
        .interactive-elements {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        .test-button {
            padding: 10px 20px;
            margin: 5px;
            border: 2px solid #333;
            background: white;
            cursor: pointer;
            border-radius: 4px;
        }
        .test-button:hover {
            background: #e0e0e0;
        }
        .test-input {
            padding: 8px;
            margin: 5px;
            border: 2px solid #333;
            border-radius: 4px;
        }
        #replayContainer {
            border: 2px solid #ddd;
            min-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f9f9f9;
            border-radius: 8px;
            position: relative;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
        .stat-item {
            background: #f0f8ff;
            padding: 10px;
            border-radius: 4px;
            text-align: center;
            border: 1px solid #e0e0e0;
        }
        .stat-label {
            font-size: 12px;
            color: #666;
            display: block;
        }
        .stat-value {
            font-size: 20px;
            font-weight: bold;
            color: #333;
        }
        .instructions {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
        }
        .instructions ol {
            margin: 10px 0;
            padding-left: 20px;
        }
        .legend {
            display: flex;
            gap: 20px;
            align-items: center;
            margin: 10px 0;
            font-size: 14px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .legend-circle {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 2px solid #fff;
        }
        .mouse-left { background: #ff4444; }
        .mouse-right { background: #4444ff; }
        .mouse-middle { background: #44ff44; }
        .mouse-move { background: transparent; border: 2px solid #ffff44; }
        .keyboard { background: #333; width: 30px; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>üé¨ MKD Combined Video + Action Capture Test</h1>
    
    <div class="instructions">
        <h3>üìã Test Instructions:</h3>
        <ol>
            <li><strong>Click "Start Combined Recording"</strong> - Allow screen capture when prompted</li>
            <li><strong>Interact with the test area below</strong> - Click buttons, type in inputs, move mouse around</li>
            <li><strong>Click "Stop Recording"</strong> after 10-20 seconds of activity</li>
            <li><strong>Click "Replay Combined"</strong> to see the video with action overlays</li>
            <li><strong>Watch the magic!</strong> - See your actions highlighted over the video playback</li>
        </ol>
    </div>

    <div class="test-container">
        <div class="section">
            <h2>üéÆ Recording Controls</h2>
            <button id="startBtn" class="btn">üî¥ Start Combined Recording</button>
            <button id="stopBtn" class="btn stop" disabled>‚èπÔ∏è Stop Recording</button>
            <button id="replayBtn" class="btn replay" disabled>‚ñ∂Ô∏è Replay Combined</button>
            <button id="clearBtn" class="btn">üóëÔ∏è Clear All Data</button>
            
            <div id="status">Ready to record video + actions</div>
            
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-circle mouse-left"></div>
                    <span>Left Click</span>
                </div>
                <div class="legend-item">
                    <div class="legend-circle mouse-right"></div>
                    <span>Right Click</span>
                </div>
                <div class="legend-item">
                    <div class="legend-circle mouse-move"></div>
                    <span>Mouse Move</span>
                </div>
                <div class="legend-item">
                    <div class="legend-circle keyboard"></div>
                    <span>Keyboard</span>
                </div>
            </div>
        </div>
        
        <div class="section">
            <h2>üìä Recording Stats</h2>
            <div class="stats">
                <div class="stat-item">
                    <span class="stat-label">Duration</span>
                    <span id="duration" class="stat-value">0.0s</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Mouse Actions</span>
                    <span id="mouseActions" class="stat-value">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Keyboard Actions</span>
                    <span id="keyboardActions" class="stat-value">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Video Chunks</span>
                    <span id="videoChunks" class="stat-value">0</span>
                </div>
            </div>
        </div>
    </div>

    <div class="test-container">
        <div class="section full-width">
            <h2>üéØ Interactive Test Area</h2>
            <div id="activityArea">
                <div class="interactive-elements">
                    <button class="test-button" onclick="this.style.background='#90EE90'">Click Me!</button>
                    <button class="test-button" onclick="alert('Button clicked!')">Alert Button</button>
                    <input type="text" class="test-input" placeholder="Type here..." />
                    <input type="number" class="test-input" placeholder="Number..." />
                    <select class="test-input">
                        <option>Select option...</option>
                        <option>Option 1</option>
                        <option>Option 2</option>
                    </select>
                </div>
                <div style="position: absolute; bottom: 10px; left: 10px; font-size: 14px; color: #888;">
                    Move your mouse, click buttons, type text - all actions will be recorded!
                </div>
            </div>
        </div>
    </div>

    <div class="test-container">
        <div class="section full-width">
            <h2>üéûÔ∏è Replay Viewer</h2>
            <div id="replayContainer">
                <span style="color: #999; font-size: 18px;">Combined recording will appear here</span>
            </div>
        </div>
    </div>

    <script>
        class CombinedCaptureTest {
            constructor() {
                this.isRecording = false;
                this.startTime = null;
                this.actions = [];
                this.mediaRecorder = null;
                this.recordedChunks = [];
                this.screenStream = null;
                
                this.initUI();
                this.setupEventListeners();
            }
            
            initUI() {
                this.startBtn = document.getElementById('startBtn');
                this.stopBtn = document.getElementById('stopBtn');
                this.replayBtn = document.getElementById('replayBtn');
                this.clearBtn = document.getElementById('clearBtn');
                this.status = document.getElementById('status');
                this.activityArea = document.getElementById('activityArea');
                this.replayContainer = document.getElementById('replayContainer');
                
                // Stats elements
                this.durationEl = document.getElementById('duration');
                this.mouseActionsEl = document.getElementById('mouseActions');
                this.keyboardActionsEl = document.getElementById('keyboardActions');
                this.videoChunksEl = document.getElementById('videoChunks');
                
                this.startBtn.addEventListener('click', () => this.startRecording());
                this.stopBtn.addEventListener('click', () => this.stopRecording());
                this.replayBtn.addEventListener('click', () => this.replayRecording());
                this.clearBtn.addEventListener('click', () => this.clearData());
                
                this.updateStats();
            }
            
            setupEventListeners() {
                // Mouse events on activity area
                this.activityArea.addEventListener('mousemove', (e) => {
                    if (this.isRecording) {
                        this.recordAction('mouse_move', {
                            x: e.clientX,
                            y: e.clientY,
                            offsetX: e.offsetX,
                            offsetY: e.offsetY
                        });
                    }
                });
                
                this.activityArea.addEventListener('mousedown', (e) => {
                    if (this.isRecording) {
                        this.recordAction('mouse_down', {
                            x: e.clientX,
                            y: e.clientY,
                            offsetX: e.offsetX,
                            offsetY: e.offsetY,
                            button: ['left', 'middle', 'right'][e.button]
                        });
                    }
                });
                
                this.activityArea.addEventListener('mouseup', (e) => {
                    if (this.isRecording) {
                        this.recordAction('mouse_up', {
                            x: e.clientX,
                            y: e.clientY,
                            offsetX: e.offsetX,
                            offsetY: e.offsetY,
                            button: ['left', 'middle', 'right'][e.button]
                        });
                    }
                });
                
                // Keyboard events on document
                document.addEventListener('keydown', (e) => {
                    if (this.isRecording) {
                        this.recordAction('key_down', {
                            key: e.key.toUpperCase(),
                            code: e.code,
                            shiftKey: e.shiftKey,
                            ctrlKey: e.ctrlKey,
                            altKey: e.altKey
                        });
                    }
                });
                
                document.addEventListener('keyup', (e) => {
                    if (this.isRecording) {
                        this.recordAction('key_up', {
                            key: e.key.toUpperCase(),
                            code: e.code
                        });
                    }
                });
            }
            
            recordAction(type, data) {
                const action = {
                    type,
                    data,
                    timestamp: this.getTimestamp()
                };
                this.actions.push(action);
                this.updateStats();
            }
            
            getTimestamp() {
                return this.startTime ? (Date.now() - this.startTime) / 1000 : 0;
            }
            
            async startRecording() {
                try {
                    this.updateStatus('Requesting screen capture permission...', 'info');
                    
                    // Request screen capture
                    this.screenStream = await navigator.mediaDevices.getDisplayMedia({
                        video: { mediaSource: 'screen' },
                        audio: false
                    });
                    
                    // Setup video recording
                    if (typeof MediaRecorder !== 'undefined' && MediaRecorder.isTypeSupported('video/webm')) {
                        const options = { mimeType: 'video/webm;codecs=vp8' };
                        this.mediaRecorder = new MediaRecorder(this.screenStream, options);
                        
                        this.mediaRecorder.ondataavailable = (event) => {
                            if (event.data.size > 0) {
                                this.recordedChunks.push(event.data);
                                this.updateStats();
                            }
                        };
                        
                        this.mediaRecorder.start(1000); // 1 second chunks
                    }
                    
                    // Start recording
                    this.isRecording = true;
                    this.startTime = Date.now();
                    this.actions = [];
                    this.recordedChunks = [];
                    
                    // Update UI
                    this.startBtn.disabled = true;
                    this.startBtn.classList.add('recording');
                    this.stopBtn.disabled = false;
                    this.updateStatus('üî¥ Recording video + actions... Interact with the test area!', 'recording-indicator');
                    
                    // Start stats updates
                    this.statsInterval = setInterval(() => this.updateStats(), 500);
                    
                } catch (error) {
                    this.updateStatus(`Error: ${error.message}`, 'error');
                    console.error(error);
                }
            }
            
            async stopRecording() {
                this.isRecording = false;
                
                // Stop video recording
                if (this.mediaRecorder && this.mediaRecorder.state !== 'inactive') {
                    this.mediaRecorder.stop();
                    await new Promise(resolve => {
                        this.mediaRecorder.onstop = resolve;
                    });
                }
                
                // Stop screen stream
                if (this.screenStream) {
                    this.screenStream.getTracks().forEach(track => track.stop());
                }
                
                // Stop stats updates
                if (this.statsInterval) {
                    clearInterval(this.statsInterval);
                }
                
                // Update UI
                this.startBtn.disabled = false;
                this.startBtn.classList.remove('recording');
                this.stopBtn.disabled = true;
                
                // Save combined recording
                await this.saveCombinedRecording();
                
                this.updateStatus('‚úÖ Recording saved! Click "Replay Combined" to see the result.', 'success');
                this.replayBtn.disabled = false;
            }
            
            async saveCombinedRecording() {
                let videoData = null;
                
                if (this.recordedChunks.length > 0) {
                    const blob = new Blob(this.recordedChunks, { type: 'video/webm' });
                    videoData = await this.blobToBase64(blob);
                }
                
                const recording = {
                    timestamp: new Date().toISOString(),
                    duration: this.startTime ? (Date.now() - this.startTime) / 1000 : 0,
                    actions: this.actions,
                    video: videoData,
                    hasVideo: !!videoData,
                    hasActions: this.actions.length > 0,
                    stats: {
                        mouseActions: this.actions.filter(a => a.type.startsWith('mouse')).length,
                        keyboardActions: this.actions.filter(a => a.type.startsWith('key')).length,
                        videoChunks: this.recordedChunks.length
                    }
                };
                
                localStorage.setItem('combined_recording', JSON.stringify(recording));
                this.updateStats();
            }
            
            blobToBase64(blob) {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onloadend = () => resolve(reader.result);
                    reader.readAsDataURL(blob);
                });
            }
            
            replayRecording() {
                const recording = JSON.parse(localStorage.getItem('combined_recording') || '{}');
                
                if (!recording.video && !recording.actions?.length) {
                    this.updateStatus('No recording found to replay', 'error');
                    return;
                }
                
                this.updateStatus('üé¨ Playing combined recording...', 'info');
                this.setupCombinedReplay(recording);
            }
            
            setupCombinedReplay(recording) {
                this.replayContainer.innerHTML = '';
                
                if (recording.video) {
                    // Create video with overlay
                    const wrapper = document.createElement('div');
                    wrapper.style.position = 'relative';
                    wrapper.style.display = 'inline-block';
                    
                    const video = document.createElement('video');
                    video.src = recording.video;
                    video.controls = true;
                    video.style.maxWidth = '100%';
                    video.style.maxHeight = '400px';
                    
                    const overlay = document.createElement('canvas');
                    overlay.style.position = 'absolute';
                    overlay.style.top = '0';
                    overlay.style.left = '0';
                    overlay.style.pointerEvents = 'none';
                    overlay.style.zIndex = '10';
                    
                    wrapper.appendChild(video);
                    wrapper.appendChild(overlay);
                    this.replayContainer.appendChild(wrapper);
                    
                    // Setup overlay for actions
                    const ctx = overlay.getContext('2d');
                    
                    video.addEventListener('loadedmetadata', () => {
                        overlay.width = video.videoWidth;
                        overlay.height = video.videoHeight;
                    });
                    
                    video.addEventListener('timeupdate', () => {
                        this.updateActionOverlay(ctx, overlay, recording.actions, video.currentTime);
                    });
                    
                    video.play();
                } else {
                    this.replayContainer.innerHTML = '<p>No video recorded, but actions were captured:<br>' + 
                        JSON.stringify(recording.stats, null, 2) + '</p>';
                }
            }
            
            updateActionOverlay(ctx, canvas, actions, currentTime) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                const timeWindow = 0.5;
                const visibleActions = actions.filter(action => 
                    Math.abs(action.timestamp - currentTime) <= timeWindow
                );
                
                visibleActions.forEach(action => {
                    const age = Math.abs(currentTime - action.timestamp);
                    const opacity = Math.max(0, 1 - (age / timeWindow));
                    
                    ctx.save();
                    ctx.globalAlpha = opacity;
                    
                    if (action.type.startsWith('mouse')) {
                        this.drawMouseAction(ctx, action);
                    } else if (action.type.startsWith('key')) {
                        this.drawKeyboardAction(ctx, action);
                    }
                    
                    ctx.restore();
                });
            }
            
            drawMouseAction(ctx, action) {
                const x = action.data.x || 100;
                const y = action.data.y || 100;
                const radius = 15;
                
                ctx.beginPath();
                ctx.arc(x / 2, y / 2, radius, 0, 2 * Math.PI); // Scale down for canvas
                
                if (action.type === 'mouse_down') {
                    ctx.fillStyle = action.data.button === 'left' ? '#ff4444' : 
                                   action.data.button === 'right' ? '#4444ff' : '#44ff44';
                    ctx.fill();
                    ctx.strokeStyle = '#ffffff';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                } else if (action.type === 'mouse_move') {
                    ctx.strokeStyle = '#ffff44';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                }
            }
            
            drawKeyboardAction(ctx, action) {
                if (action.type !== 'key_down') return;
                
                const x = 50;
                const y = 50 + (Math.random() * 100); // Random vertical position
                
                ctx.fillStyle = '#333333';
                ctx.fillRect(x, y, 80, 25);
                
                ctx.strokeStyle = '#666666';
                ctx.lineWidth = 1;
                ctx.strokeRect(x, y, 80, 25);
                
                ctx.fillStyle = '#ffffff';
                ctx.font = '14px monospace';
                ctx.textAlign = 'center';
                ctx.fillText(action.data.key, x + 40, y + 17);
            }
            
            clearData() {
                localStorage.removeItem('combined_recording');
                this.actions = [];
                this.recordedChunks = [];
                this.replayContainer.innerHTML = '<span style="color: #999; font-size: 18px;">Combined recording will appear here</span>';
                this.replayBtn.disabled = true;
                this.updateStats();
                this.updateStatus('All data cleared', 'info');
            }
            
            updateStats() {
                const duration = this.startTime ? (Date.now() - this.startTime) / 1000 : 0;
                const mouseActions = this.actions.filter(a => a.type.startsWith('mouse')).length;
                const keyboardActions = this.actions.filter(a => a.type.startsWith('key')).length;
                
                this.durationEl.textContent = duration.toFixed(1) + 's';
                this.mouseActionsEl.textContent = mouseActions;
                this.keyboardActionsEl.textContent = keyboardActions;
                this.videoChunksEl.textContent = this.recordedChunks.length;
            }
            
            updateStatus(message, type = 'info') {
                this.status.textContent = message;
                this.status.className = type === 'success' ? 'success' : 
                                       type === 'error' ? 'error' : 
                                       type === 'recording-indicator' ? 'recording-indicator' : '';
            }
        }
        
        // Initialize the test
        const test = new CombinedCaptureTest();
    </script>
</body>
</html>